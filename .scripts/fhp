# $Id: ~/.scripts/fhp,v 1.3 2014/06/31 09:59:26 -tclover Exp $

# A handy script to put firefox profile to tmpfs or zram device.
# A frst environment variable is required in ~/.bashrc or whatever:
# `export FHP=$(ls -d ~/.mozilla/firefox/*.default)';
# and maybe something like: */30 * * * * $USER ~/.scripts/fhp
# to keep track of changes.
# If you have an entry like this in your `/etc/fstab':
# tmp	/tmp	tmpfs	mode=0777,size=128M,noatime	0 0
# just set `TMPFS=/tmp' in your env; or else, if you have a fs
# mount on top of a zram device, then just set ZRAMFS.

# @ENV_VARIABLE: FHP
# @DESCRIPTION: Firefox profile
# @EXEMPLE: FHP=/$USER/.mozilla/firefox/abhd123.default

# @ENV_VARIABLE: ZRAMFS
# @DESCRIPTION: Zram block device backed FS to use for firefox profile
# @EXAMPLE: ZRAMFS=/zram

# @ENV_VARIABLE: TMPFS
# @DESCRIPTION: tmpfs directory to use instead of zram fs backed fs
# @EXEMPLE: TMPFS=/tmp/.private/$USER

# @FUNCTION: die
# @DESCRIPTION: hlper function
# @USAGE: <string>
die() {
	local _ret=$?
	echo "* $@"
	exit $_ret
}

# @ENV_VARIABLE: FHP
# @DESCRIPTION: Firefox Home Profile (~/.mozilla/firefox/*.default)

# @FUNCTION: fhp
# @DESCRIPTION: put firefox profile to tmpfs by default, or use zam instead
fhp() {
:	${FHP:=$(ls -d ~/.mozilla/firefox/*.default)}
	local _d="${FHP%/*}" _p="${FHP##*/}"

	[[ -z "$FHP" ]] && die "no profile found"

	if [[ -n "$TMPFS" ]]; then
		sudo mount --bind $FHP "$TMPFS" ||
		die "failed to mount zram/ext4 fhp"
	elif [[ -n "$ZRAMFS" ]]; then
		sudo mount --bind "$FHP" "$ZRAMFS"||
		die "failed to mount tmpfs fhp"
	fi

	pushd "$_d"
	if [[ -f "$FHP"/.unpacked ]]; then
		tar -X $_p/.unpacked -czpf $_p.tmp.tgz $_p ||
		die "failed to pack the profie"
		mv $_p.tgz $_p.old.tgz || die "failed to override .old profile"
		mv $_p.tmp.tgz $_p.tgz || die "failed to move the profile"
	else
		tar xzpf $_p.tgz || tar xzpf $_p.old.tgz &&
		touch $FHP/.unpacked || echo "failed to unpack the profile"
	fi
	popd
}

# vim:fenc=utf-8:ft=sh:ci:pi:sts=0:sw=2:ts=2:
